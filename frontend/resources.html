<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Career Resources - CareerBridge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            --slate-950: #020617;
        }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--slate-950); 
            color: #cbd5e1;
        }
        #orb-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
        }
        #page-wrapper {
            position: relative;
            z-index: 10;
        }
        .gradient-text {
            background: linear-gradient(135deg, #a7b2f5 0%, #cda3f7 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .nav-blur { 
            backdrop-filter: blur(20px); 
            background: rgba(15, 23, 42, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(118, 75, 162, 0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .form-input, .resume-input { 
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid #334155;
            border-radius: 0.75rem; 
            padding: 1rem 1.25rem; 
            transition: all 0.3s ease; 
            width: 100%;
            color: white;
        }
        .form-input::placeholder, .resume-input::placeholder { color: #64748b; }
        .form-input:focus, .resume-input:focus { 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2); 
            outline: none; 
            background: var(--slate-900);
        }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
        }

        .advice-card { background-color: var(--slate-800); border: 1px solid #334155; border-radius: 1rem; transition: all 0.3s ease; animation: popIn 0.5s ease-out forwards; opacity: 0; }
        .advice-card:hover { transform: translateY(-4px); border-color: #667eea; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .advice-tab { transition: all 0.3s ease; color: #94a3b8; }
        .advice-tab.active { color: #a7b2f5; border-bottom-color: #a7b2f5; font-weight: 600; }
        
        .form-section-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(16px);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-secondary { background-color: #312e81; color: #e0e7ff; font-weight:600; transition: all 0.3s ease; }
        .btn-secondary:hover { background-color: #3730a3; }
        .btn-danger { background-color: #991b1b; color: #fecaca; font-weight:600; transition: all 0.3s ease; }
        .btn-danger:hover { background-color: #b91c1c; }
        
        #resume-preview-wrapper {
            background-color: rgba(2, 6, 23, 0.5);
            padding: 2rem;
            border-radius: 0.5rem;
        }
        #resume-preview {
            background-color: var(--slate-900);
            color: #d1d5db;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid #334155;
            min-height: 400px;
        }
        
        /* PDF Export Styles - Clean professional look */
        #resume-preview.pdf-mode {
            background-color: #ffffff !important;
            color: #1e293b !important;
            border: none !important;
            box-shadow: none !important;
        }
        #resume-preview.pdf-mode .resume-name { color: #1e40af !important; }
        #resume-preview.pdf-mode .resume-section-title { color: #1e40af !important; border-bottom-color: #cbd5e1 !important; }
        #resume-preview.pdf-mode .resume-header { border-bottom-color: #cbd5e1 !important; }
        #resume-preview.pdf-mode .resume-contact { color: #475569 !important; }
        #resume-preview.pdf-mode .contact-item { color: #475569 !important; }
        #resume-preview.pdf-mode a { color: #1e40af !important; }
        #resume-preview.pdf-mode p, #resume-preview.pdf-mode ul, #resume-preview.pdf-mode li { color: #334155 !important; }
        #resume-preview.pdf-mode .experience-item h3 { color: #1e293b !important; }
        #resume-preview.pdf-mode .experience-item p { color: #475569 !important; }
        #resume-preview.pdf-mode .skills-container span { 
            background-color: #e0e7ff !important; 
            color: #3730a3 !important; 
            border: 1px solid #c7d2fe !important;
        }
        
        #resume-preview a { color: #a7b2f5; }
        #resume-preview .resume-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #334155; padding-bottom: 1rem; margin-bottom: 1.5rem; }
        #resume-preview .resume-name { font-size: 2.5rem; font-weight: 900; color: #a7b2f5; line-height: 1.1; }
        #resume-preview .resume-contact { text-align: right; font-size: 0.875rem; color: #9ca3af; }
        #resume-preview .contact-item { display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem; margin-bottom: 0.25rem; }
        #resume-preview .resume-section-title { font-size: 1.1rem; font-weight: 800; color: #a7b2f5; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #334155; padding-bottom: 0.25rem; }
        #resume-preview ul { list-style-type: disc; padding-left: 1rem; font-size: 0.95rem; line-height: 1.6; color: #d1d5db; }
        #resume-preview .experience-item h3 { font-weight: 700; font-size: 1.05rem; color: #f3f4f6; }
        #resume-preview .experience-item p { color: #9ca3af; font-size: 0.9rem; margin-bottom: 0.25rem; }
        #resume-preview .skills-container span { background-color: var(--slate-800); color: #e5e7eb; font-size: 0.8rem; }
    </style>
</head>
<body>

    <canvas id="orb-canvas"></canvas>

    <div id="page-wrapper">
        <nav class="sticky top-0 left-0 right-0 z-50 nav-blur">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex-shrink-0"><a href="../index.html" class="text-2xl font-black gradient-text">CareerBridge</a></div>
                    <div class="hidden md:block">
                        <div class="flex items-center space-x-8">
                            <a href="jobs.html" class="text-slate-400 hover:text-white font-medium">Jobs</a>
                            <a href="resources.html" class="gradient-text font-bold">Resources</a>
                            <a href="about.html" class="text-slate-400 hover:text-white font-medium">About</a>
                            <a href="components/post-job.html" class="btn-primary text-white px-6 py-2 rounded-full font-semibold text-sm">Post Job</a>
                        </div>
                    </div>
                    <div class="md:hidden"><button id="mobile-menu-btn" class="p-2 rounded-lg text-slate-400 hover:bg-slate-700"><i class="fas fa-bars"></i></button></div>
                </div>
            </div>
            <div id="mobile-menu" class="hidden md:hidden px-4 pt-2 pb-4 space-y-1">
                 <a href="jobs.html" class="block px-3 py-2 rounded-md font-medium text-slate-300 hover:bg-slate-700">Jobs</a>
                 <a href="resources.html" class="block px-3 py-2 rounded-md font-medium text-indigo-400 bg-slate-800">Resources</a>
                 <a href="about.html" class="block px-3 py-2 rounded-md font-medium text-slate-300 hover:bg-slate-700">About</a>
                 <a href="components/post-job.html" class="block px-3 py-2 rounded-md font-medium text-slate-300 hover:bg-slate-700">Post Job</a>
            </div>
        </nav>

        <header class="relative py-24 lg:py-32">
            <div class="relative z-10 max-w-4xl mx-auto text-center px-4">
                <span class="text-sm font-bold uppercase text-indigo-400">AI-Powered Career Growth</span>
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-black text-slate-100 mt-2 mb-6">Your Personal <span class="gradient-text">Skill Advisor</span></h1>
                <p class="text-lg md:text-xl text-slate-400 max-w-2xl mx-auto leading-relaxed">Enter your current and desired roles to get a customized roadmap of skills, resources, and salary insights to level up your career.</p>
            </div>
        </header>

        <main>
            <section id="advisor-section" class="py-20">
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="glass-card p-8">
                        <h2 class="text-2xl font-bold text-center text-slate-100 mb-6">Chart Your Career Path</h2>
                        <div class="grid md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label for="current-role-input" class="font-semibold text-slate-300 mb-2 block">Your Current Role</label>
                                <input type="text" id="current-role-input" class="form-input" placeholder="e.g., Software Engineer">
                            </div>
                            <div>
                                <label for="next-role-input" class="font-semibold text-slate-300 mb-2 block">Your Desired Role</label>
                                <input type="text" id="next-role-input" class="form-input" placeholder="e.g., Senior Software Engineer">
                            </div>
                        </div>
                        <button id="get-advice-btn" class="w-full btn-primary text-white font-bold px-8 py-4 rounded-xl text-lg">
                            <span id="btn-icon"><i class="fas fa-magic mr-2"></i></span>
                            <span id="btn-text">Generate My Career Plan</span>
                        </button>
                    </div>
                    <div id="ai-results" class="mt-12"></div>
                </div>
            </section>

            <section id="ats-scanner" class="py-20 bg-slate-900/50">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-12">
                        <span class="text-sm font-bold uppercase text-indigo-400">Optimize For ATS</span>
                        <h2 class="text-3xl md:text-4xl font-black text-slate-100 mt-2">ATS Resume Scanner & Suggestions</h2>
                        <p class="text-slate-400 mt-2">Paste your resume (or upload PDF/TXT) and the job description. Get a score, missing keywords, and specific improvements.</p>
                    </div>

                    <div class="grid lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div class="form-section-card">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-xl font-bold text-slate-100">Your Resume</h3>
                                    <label class="btn-secondary px-3 py-2 rounded-lg cursor-pointer">
                                        <i class="fas fa-file-upload mr-2"></i>Upload PDF/TXT
                                        <input id="resume-file-input" type="file" accept=".pdf,.txt" class="hidden">
                                    </label>
                                </div>
                                <textarea id="resume-text" rows="12" class="resume-input" placeholder="Paste your resume text here (recommended for best accuracy)..."></textarea>
                                <p id="resume-file-name" class="text-xs text-slate-500 mt-2"></p>
                            </div>
                            <div class="form-section-card">
                                <h3 class="text-xl font-bold text-slate-100 mb-3">Job Description</h3>
                                <textarea id="job-text" rows="10" class="resume-input" placeholder="Paste the job description here..."></textarea>
                            </div>
                            <div class="flex flex-wrap gap-3">
                                <label class="flex items-center gap-2 text-slate-300"><input id="use-ai-suggestions" type="checkbox" class="accent-indigo-500" checked>Use AI suggestions</label>
                                <button id="scan-btn" class="btn-primary text-white px-6 py-3 rounded-xl font-bold"><i class="fas fa-search mr-2"></i>Scan Resume</button>
                            </div>
                        </div>

                        <div id="ats-results" class="space-y-6">
                            <div class="glass-card p-6">
                                <h3 class="text-xl font-bold text-slate-100 mb-4">ATS Match Score</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 items-center">
                                    <div class="sm:col-span-1">
                                        <canvas id="atsScoreChart" height="180"></canvas>
                                    </div>
                                    <div class="sm:col-span-2 space-y-3">
                                        <p id="ats-score-summary" class="text-slate-300">Run a scan to see your score.</p>
                                        <ul id="ats-strengths" class="list-disc list-inside text-emerald-300 text-sm"></ul>
                                        <ul id="ats-issues" class="list-disc list-inside text-amber-300 text-sm"></ul>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-card p-6">
                                <h3 class="text-xl font-bold text-slate-100 mb-4">Keyword Coverage</h3>
                                <div class="grid sm:grid-cols-2 gap-6">
                                    <div>
                                        <h4 class="font-semibold text-slate-200 mb-2">Matched</h4>
                                        <div id="matched-keywords" class="flex flex-wrap gap-2"></div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-slate-200 mb-2">Missing</h4>
                                        <div id="missing-keywords" class="flex flex-wrap gap-2"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-card p-6">
                                <h3 class="text-xl font-bold text-slate-100 mb-4">Actionable Suggestions</h3>
                                <ol id="ats-suggestions" class="list-decimal list-inside text-slate-300 space-y-2"></ol>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-slate-950/80 text-white border-t border-slate-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-12 mb-10">
                    <div class="lg:col-span-1">
                        <a href="../index.html" class="text-2xl font-black gradient-text mb-4 inline-block">CareerBridge</a>
                        <p class="text-slate-400 text-sm">Your career growth partner, connecting talent with opportunity across India.</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-100 mb-4 tracking-wider">Quick Links</h4>
                        <ul class="space-y-3">
                            <li><a href="about.html" class="text-slate-400 hover:text-white transition-colors">About Us</a></li>
                            <li><a href="jobs.html" class="text-slate-400 hover:text-white transition-colors">Jobs</a></li>
                            <li><a href="resources.html" class="text-slate-400 hover:text-white transition-colors">Resources</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-100 mb-4 tracking-wider">Legal</h4>
                        <ul class="space-y-3">
                            <li><a href="#" class="text-slate-400 hover:text-white transition-colors">Privacy Policy</a></li>
                            <li><a href="#" class="text-slate-400 hover:text-white transition-colors">Terms of Service</a></li>
                            <li><a href="#" class="text-slate-400 hover:text-white transition-colors">Contact</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-100 mb-4 tracking-wider">Connect With Us</h4>
                        <div class="flex space-x-5">
                            <a href="#" aria-label="Twitter" class="text-slate-400 hover:text-white text-xl transition-colors"><i class="fab fa-twitter"></i></a>
                            <a href="#" aria-label="LinkedIn" class="text-slate-400 hover:text-white text-xl transition-colors"><i class="fab fa-linkedin-in"></i></a>
                            <a href="#" aria-label="GitHub" class="text-slate-400 hover:text-white text-xl transition-colors"><i class="fab fa-github"></i></a>
                            <a href="#" aria-label="Instagram" class="text-slate-400 hover:text-white text-xl transition-colors"><i class="fab fa-instagram"></i></a>
                        </div>
                    </div>
                </div>
                <div class="border-t border-slate-800 pt-8 text-center text-slate-500">
                    <p>&copy; 2025 CareerBridge. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Orb Canvas Effect ---
    const canvas = document.getElementById('orb-canvas');
    if (canvas) {
        const ctx = canvas.getContext('2d');
        const colors = ["#667eea", "#764ba2", "#a7b2f5", "#4f46e5"];
        let orbs = [];
        let mouse = { x: null, y: null };
        const cursorOrb = { x: 0, y: 0, size: 30, vx: 0, vy: 0 };
        class Orb {
            constructor() { this.x = Math.random() * window.innerWidth; this.y = Math.random() * window.innerHeight; this.vx = (Math.random() - 0.5) * 1.5; this.vy = (Math.random() - 0.5) * 1.5; this.radius = Math.random() * 20 + 10; this.color = colors[Math.floor(Math.random() * colors.length)]; }
            draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.globalAlpha = 0.7; ctx.shadowColor = this.color; ctx.shadowBlur = 30; ctx.fill(); }
            update() { this.x += this.vx; this.y += this.vy; if (this.x < this.radius || this.x > window.innerWidth - this.radius) this.vx *= -1; if (this.y < this.radius || this.y > window.innerHeight - this.radius) this.vy *= -1; }
        }
        function init() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; orbs = Array.from({ length: 15 }, () => new Orb()); }
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            orbs.forEach(orb => { orb.update(); orb.draw(); });
            if(mouse.x !== null) {
                cursorOrb.vx += (mouse.x - cursorOrb.x) * 0.05; cursorOrb.vy += (mouse.y - cursorOrb.y) * 0.05;
                cursorOrb.x += cursorOrb.vx; cursorOrb.y += cursorOrb.vy;
                cursorOrb.vx *= 0.9; cursorOrb.vy *= 0.9;
                ctx.beginPath(); ctx.arc(cursorOrb.x, cursorOrb.y, cursorOrb.size, 0, Math.PI * 2);
                const gradient = ctx.createRadialGradient(cursorOrb.x, cursorOrb.y, 0, cursorOrb.x, cursorOrb.y, cursorOrb.size);
                gradient.addColorStop(0, "rgba(167, 178, 245, 0.3)"); gradient.addColorStop(1, "rgba(167, 178, 245, 0)");
                ctx.fillStyle = gradient; ctx.fill();
            }
            requestAnimationFrame(animate);
        }
        window.addEventListener('resize', init);
        window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
        init(); animate();
    }
    
    // --- SKILL ADVISOR SCRIPT ---
    const getAdviceBtn = document.getElementById('get-advice-btn');
    const btnText = document.getElementById('btn-text');
    const btnIcon = document.getElementById('btn-icon');
    const currentRoleInput = document.getElementById('current-role-input');
    const nextRoleInput = document.getElementById('next-role-input');
    const aiResultsContainer = document.getElementById('ai-results');
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    let skillChart = null;
    let salaryChart = null;

    if(mobileMenuBtn) mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
    
    async function fetchAIAdvice() {
        const currentRole = currentRoleInput.value.trim();
        const nextRole = nextRoleInput.value.trim();
        if (!currentRole || !nextRole) {
            alert("Please enter both your current and desired roles.");
            return;
        }
        getAdviceBtn.disabled = true;
        btnText.textContent = 'Crafting your plan...';
        btnIcon.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>`;
        aiResultsContainer.innerHTML = `<div class="glass-card p-8 text-center text-slate-400">Generating AI insights... This may take a moment.</div>`;
        aiResultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Updated API key - Using Gemini 2.0 Flash Experimental
        const apiKey = "AIzaSyBLmEGSZai1zOtoH7zu4kKZprTUXu6IgAQ";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        const prompt = `Generate a career plan for a ${currentRole} in India aiming to become a ${nextRole}. Respond ONLY with a single, clean JSON object. The JSON must have this exact structure: {"summary": "A brief, one-sentence summary of the career transition.", "skillScores": { "labels": ["Skill 1", "Skill 2", "Skill 3", "Skill 4"], "score": [/* 4 numbers between 1-10 */] }, "salaryProjection": { "labels": ["Year 1", "Year 2", "Year 3", "Year 4", "Year 5"], "salary": [/* 5 numbers for salary in LPA */] }, "technicalSkills": [ {"name": "Skill Name", "description": "...", "icon": "fa-solid fa-some-icon"} ], "softSkills": [ {"name": "Skill Name", "description": "...", "icon": "fa-solid fa-some-icon"} ], "actionPlan": [ {"step": "Months 1-3", "action": "...", "icon": "fa-solid fa-some-icon"} ] }`;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], safetySettings: [{ category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },{ category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },{ category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },{ category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' }]};

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { 
                const errorText = await response.text();
                throw new Error(`API error: ${response.status}. Please update your Google Gemini API key. Get one free at: https://makersuite.google.com/app/apikey`); 
            }
            const result = await response.json();
            if (result.candidates && result.candidates[0].content.parts) {
                const cleanedJsonText = result.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                renderAIResults(currentRole, nextRole, JSON.parse(cleanedJsonText));
            } else { throw new Error("Invalid AI response structure. The model may be blocked or returning an unexpected format."); }
        } catch (error) {
            aiResultsContainer.innerHTML = `
                <div class="glass-card p-8 text-center">
                    <div class="text-red-400 mb-4">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">AI Feature Unavailable</h3>
                        <p class="mb-4">${error.message}</p>
                    </div>
                    <div class="text-slate-400 text-sm">
                        <p class="mb-2"><strong>To enable this feature:</strong></p>
                        <ol class="text-left max-w-md mx-auto space-y-2">
                            <li>1. Visit <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-indigo-400 hover:underline">Google AI Studio</a></li>
                            <li>2. Get your free API key (Google account required)</li>
                            <li>3. Replace the API key in resources.html (line 266)</li>
                            <li>4. Refresh this page</li>
                        </ol>
                    </div>
                </div>
            `;
        } finally {
            getAdviceBtn.disabled = false;
            btnText.textContent = 'Generate My Career Plan';
            btnIcon.innerHTML = `<i class="fas fa-magic mr-2"></i>`;
        }
    }

    if(getAdviceBtn) getAdviceBtn.addEventListener('click', fetchAIAdvice);

    function renderAIResults(currentRole, nextRole, response) {
        aiResultsContainer.innerHTML = '';
        const resultsWrapper = document.createElement('div');
        resultsWrapper.className = 'glass-card p-6 sm:p-8';
        resultsWrapper.innerHTML = `<div id="plan-to-print"><div class="flex justify-between items-start mb-6 flex-wrap gap-4"><div><h3 class="text-2xl font-bold text-slate-100 mb-1">Your Roadmap: <span class="gradient-text">${currentRole} to ${nextRole}</span></h3><p class="text-slate-400 max-w-xl">${response.summary || ''}</p></div></div><div class="grid lg:grid-cols-5 gap-8 items-start"><div class="lg:col-span-2 space-y-8"><div><h4 class="text-lg font-bold text-center text-slate-300 mb-4">Key Focus Areas</h4><div class="p-4 bg-slate-900/50 rounded-xl"><canvas id="skillBarChart"></canvas></div></div><div><h4 class="text-lg font-bold text-center text-slate-300 mb-4">Salary Projection (LPA)</h4><div class="p-4 bg-slate-900/50 rounded-xl"><canvas id="salaryLineChart"></canvas></div></div></div><div class="lg:col-span-3"><div class="border-b border-slate-700 mb-6"><nav class="flex flex-wrap -mb-px" id="advice-tabs"></nav></div><div id="tab-content"></div></div></div></div>`;
        aiResultsContainer.appendChild(resultsWrapper);
        const tabsData = [{ id: 'tech', label: 'Core Skills', data: response.technicalSkills, color: 'indigo' }, { id: 'soft', label: 'Soft Skills', data: response.softSkills, color: 'sky' }, { id: 'plan', label: 'Action Plan', data: response.actionPlan.map(p => ({ name: p.step, description: p.action, icon: p.icon })), color: 'emerald' }];
        tabsData.forEach((tabInfo, index) => createTab(tabInfo, index, resultsWrapper));
        if (response.skillScores) renderSkillChart(response.skillScores);
        if (response.salaryProjection) renderSalaryChart(response.salaryProjection);
        setupTabs();
    }
    
    function createTab(tabInfo, index, wrapper) {
        const tabContainer = wrapper.querySelector('#advice-tabs'); const tabContentContainer = wrapper.querySelector('#tab-content');
        const tabButton = document.createElement('button');
        tabButton.dataset.tab = tabInfo.id;
        tabButton.className = 'advice-tab py-4 px-4 border-b-2 border-transparent text-sm sm:text-base';
        tabButton.textContent = tabInfo.label;
        if (index === 0) tabButton.classList.add('active');
        tabContainer.appendChild(tabButton);
        const contentDiv = document.createElement('div');
        contentDiv.id = `${tabInfo.id}-content`;
        contentDiv.className = `space-y-4 ${index > 0 ? 'hidden' : ''}`;
        if (tabInfo.data && Array.isArray(tabInfo.data)) { tabInfo.data.forEach((item, i) => { contentDiv.appendChild(createAdviceCard(item.name, item.description, item.icon, tabInfo.color, i)); }); }
        tabContentContainer.appendChild(contentDiv);
    }

    function createAdviceCard(title, description, icon, color, index) {
        const card = document.createElement('div'); card.className = 'advice-card flex items-start gap-4 p-4 relative'; card.style.animationDelay = `${index * 100}ms`;
        const safeIcon = icon || 'fa-solid fa-star';
        const linkedDescription = description.replace(/\((.*?)\)/g, '<a href="#" class="text-indigo-400 font-semibold hover:underline">$1</a>');
        card.innerHTML = `<div class="flex-shrink-0 w-10 h-10 rounded-lg bg-slate-700 text-${color}-400 flex items-center justify-center"><i class="${safeIcon}"></i></div><div class="flex-1"><h4 class="font-bold text-slate-100">${title}</h4><p class="text-slate-400 text-sm">${linkedDescription}</p></div>`;
        return card;
    }

    function renderSkillChart(skillData) {
        const ctx = document.getElementById('skillBarChart').getContext('2d'); if (skillChart) skillChart.destroy();
        Chart.defaults.color = '#94a3b8';
        skillChart = new Chart(ctx, { type: 'bar', data: { labels: skillData.labels, datasets: [{ label: 'Focus Score', data: skillData.score, backgroundColor: ['rgba(99, 102, 241, 0.7)', 'rgba(56, 189, 248, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(245, 158, 11, 0.7)'], borderColor: ['#818cf8', '#7dd3fc', '#6ee7b7', '#fcd34d'], borderWidth: 2, borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, max: 10, grid: { display: false }, ticks: { display: false } }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } } });
    }

    function renderSalaryChart(salaryData) {
        const ctx = document.getElementById('salaryLineChart').getContext('2d'); if (salaryChart) salaryChart.destroy();
        Chart.defaults.color = '#94a3b8';
        salaryChart = new Chart(ctx, { type: 'line', data: { labels: salaryData.labels, datasets: [{ label: 'Projected Salary (LPA)', data: salaryData.salary, fill: true, backgroundColor: 'rgba(99, 102, 241, 0.1)', borderColor: '#818cf8', tension: 0.4, pointBackgroundColor: '#818cf8', pointRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, ticks: { callback: value => `₹${value}L` } } }, plugins: { legend: { display: false } } } });
    }

    function setupTabs() {
        const tabs = document.querySelectorAll('.advice-tab'); const contents = document.querySelectorAll('#tab-content > div');
        tabs.forEach(tab => { tab.addEventListener('click', () => { tabs.forEach(t => t.classList.remove('active')); tab.classList.add('active'); const target = tab.dataset.tab; contents.forEach(content => content.classList.toggle('hidden', content.id !== `${target}-content`)); }); });
    }
    
    // --- ATS SCANNER LOGIC ---
    if (window.pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    }

    const resumeFileInput = document.getElementById('resume-file-input');
    const resumeTextEl = document.getElementById('resume-text');
    const jobTextEl = document.getElementById('job-text');
    const scanBtn = document.getElementById('scan-btn');
    const useAIEl = document.getElementById('use-ai-suggestions');

    const scoreChartCanvas = document.getElementById('atsScoreChart');
    let scoreChart = null;

    const matchedEl = document.getElementById('matched-keywords');
    const missingEl = document.getElementById('missing-keywords');
    const strengthsEl = document.getElementById('ats-strengths');
    const issuesEl = document.getElementById('ats-issues');
    const suggestionsEl = document.getElementById('ats-suggestions');
    const scoreSummaryEl = document.getElementById('ats-score-summary');

    const STOPWORDS = new Set(['the','and','for','with','that','this','you','your','are','our','from','will','have','has','into','over','under','above','below','not','but','or','as','of','to','in','on','at','an','a','be','is','by','we','they','it','their','his','her','them']);

    function normalize(text){
        return (text || '').toLowerCase().replace(/[^a-z0-9\.\+\-\/# ]+/g,' ');
    }

    function extractKeywords(text){
        const tokens = normalize(text).split(/\s+/).filter(w => w.length > 2 && !STOPWORDS.has(w));
        const freq = {};
        for (const t of tokens){ freq[t] = (freq[t]||0)+1; }
        const sorted = Object.entries(freq).sort((a,b)=>b[1]-a[1]).map(([w])=>w);
        // Heuristic: top 40 keywords max
        return sorted.slice(0,40);
    }

    function computeScore(resume, jd){
        const resumeNorm = normalize(resume);
        const jdKeywords = extractKeywords(jd);
        const matched = [];
        const missing = [];
        jdKeywords.forEach(k => (resumeNorm.includes(k) ? matched : missing).push(k));

        // Signals
        const hasEmail = /[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/i.test(resume);
        const hasPhone = /(\+?\d[\d\s\-\(\)]{8,}\d)/.test(resume);
        const hasSections = ['experience','education','skills'].map(s => new RegExp(`\\b${s}\\b`,'i').test(resume));
        const bulletCount = (resume.match(/(^|\n)\s*(\-|•|\*)\s+/g) || []).length;
        const wordCount = (resume.match(/\b\w+\b/g) || []).length;

        // Score components (0-100)
        let score = 0;
        const keywordScore = Math.round((matched.length / Math.max(1, matched.length + missing.length)) * 55); // weight 55
        const sectionScore = Math.round((hasSections.filter(Boolean).length/3) * 20); // weight 20
        const contactScore = (hasEmail?10:0) + (hasPhone?5:0); // weight 15
        const bulletsScore = Math.min(10, bulletCount); // up to 10
        const lengthPenalty = (wordCount < 200 || wordCount > 1200) ? -10 : 0;
        score = Math.min(100, Math.max(0, keywordScore + sectionScore + contactScore + bulletsScore + lengthPenalty));

        const strengths = [];
        const issues = [];
        if (matched.length >= 10) strengths.push('Strong keyword coverage.'); else issues.push('Add more keywords from the job description.');
        if (hasEmail && hasPhone) strengths.push('Contact details present.'); else issues.push('Include both email and phone number.');
        if (hasSections.filter(Boolean).length === 3) strengths.push('Core sections (Experience, Education, Skills) found.'); else issues.push('Add clear section headings: Experience, Education, Skills.');
        if (bulletCount >= 8) strengths.push('Good use of bullet points.'); else issues.push('Use 8–15 concise bullet points for achievements.');
        if (wordCount >= 350 && wordCount <= 900) strengths.push('Good overall length.'); else issues.push('Keep resume between 350–900 words for ATS readability.');

        return { score, matched, missing, strengths, issues, jdKeywords };
    }

    async function extractTextFromPDF(file){
        const data = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data }).promise;
        let fullText = '';
        for (let i=1;i<=pdf.numPages;i++){
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            const strings = content.items.map(it => it.str);
            fullText += strings.join(' ') + '\n';
        }
        return fullText;
    }

    if (resumeFileInput){
        resumeFileInput.addEventListener('change', async (e)=>{
            const file = e.target.files && e.target.files[0];
            const nameEl = document.getElementById('resume-file-name');
            if (!file) return;
            nameEl.textContent = `Selected: ${file.name}`;
            try{
                let text = '';
                if (file.name.toLowerCase().endsWith('.pdf')){
                    text = await extractTextFromPDF(file);
                } else {
                    text = await file.text();
                }
                resumeTextEl.value = text.trim();
            } catch(err){
                nameEl.textContent += ' (Failed to read file)';
            }
        });
    }

    function renderChips(container, items, color){
        container.innerHTML = '';
        items.forEach(k => {
            const span = document.createElement('span');
            span.className = `inline-block text-xs px-3 py-1 rounded-full border ${color==='good'?'border-emerald-400 text-emerald-300':'border-amber-400 text-amber-300'} bg-slate-800`;
            span.textContent = k;
            container.appendChild(span);
        });
    }

    function renderScore(score){
        if (!scoreChartCanvas) return;
        if (scoreChart) scoreChart.destroy();
        scoreChart = new Chart(scoreChartCanvas.getContext('2d'),{
            type:'doughnut',
            data:{ labels:['Score','Gap'], datasets:[{ data:[score, 100-score], backgroundColor:['#22c55e','#1f2937'], borderWidth:0 }]},
            options:{ cutout:'70%', plugins:{ legend:{display:false}, tooltip:{enabled:false} } }
        });
        scoreSummaryEl.textContent = `Estimated ATS match: ${score}%`;
    }

    async function aiSuggestions(resume, jd){
        try{
            const apiKey = "AIzaSyBLmEGSZai1zOtoH7zu4kKZprTUXu6IgAQ";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const prompt = `You are an ATS coach. Review the RESUME against the JOB DESCRIPTION. Reply with ONLY valid JSON: {"suggestions": ["..."], "criticalMissingKeywords": ["..."], "summary": "..."}` +
            `\nRESUME:\n${resume.substring(0,9000)}\nJOB DESCRIPTION:\n${jd.substring(0,9000)}`;
            const payload = { contents: [{ role: 'user', parts: [{ text: prompt }]}] };
            const resp = await fetch(apiUrl,{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
            if (!resp.ok) throw new Error('AI request failed');
            const result = await resp.json();
            const txt = result?.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
            const clean = txt.replace(/```json|```/g,'');
            return JSON.parse(clean);
        }catch{
            return null;
        }
    }

    async function runScan(){
        const resume = (resumeTextEl?.value || '').trim();
        const jd = (jobTextEl?.value || '').trim();
        if (!resume || !jd){ alert('Please provide both Resume text and Job Description.'); return; }

        const base = computeScore(resume, jd);
        renderScore(base.score);
        renderChips(matchedEl, base.matched, 'good');
        renderChips(missingEl, base.missing, 'bad');
        strengthsEl.innerHTML = base.strengths.map(s=>`<li>${s}</li>`).join('');
        issuesEl.innerHTML = base.issues.map(s=>`<li>${s}</li>`).join('');
        suggestionsEl.innerHTML = '';

        if (useAIEl && useAIEl.checked){
            const ai = await aiSuggestions(resume, jd);
            if (ai){
                if (Array.isArray(ai.criticalMissingKeywords)){
                    const extraMissing = ai.criticalMissingKeywords.filter(k => !base.matched.includes(k));
                    if (extraMissing.length) renderChips(missingEl, Array.from(new Set([...base.missing, ...extraMissing])), 'bad');
                }
                if (Array.isArray(ai.suggestions)){
                    suggestionsEl.innerHTML = ai.suggestions.map(s=>`<li>${s}</li>`).join('');
                }
                if (ai.summary){ scoreSummaryEl.textContent += ` — ${ai.summary}`; }
            }
        }
    }

    if (scanBtn) scanBtn.addEventListener('click', runScan);
});
</script>
</body>
</html>