<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CareerBridge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
        }
        .gradient-text {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .nav-blur {
            backdrop-filter: blur(20px);
            background: rgba(15, 23, 42, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stat-card {
            background: linear-gradient(145deg, #1e293b, #28354c);
            border: 1px solid rgba(251, 191, 36, 0.2);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.4);
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #0f172a;
        }
        .data-table {
            background: #1e293b;
            border-radius: 1rem;
            overflow: hidden;
        }
        .table-row {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s ease;
        }
        .table-row:hover {
            background: rgba(251, 191, 36, 0.05);
        }
        .btn-edit {
            background: #3b82f6;
            transition: all 0.2s ease;
        }
        .btn-edit:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        .btn-delete {
            background: #ef4444;
            transition: all 0.2s ease;
        }
        .btn-delete:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #1e293b;
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="text-slate-300">
    <nav class="fixed top-0 left-0 right-0 z-50 nav-blur">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <a href="../../index.html" class="text-2xl font-black gradient-text">
                        <i class="fas fa-crown mr-2"></i>Admin Dashboard
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-slate-400">Welcome, <span id="admin-name" class="text-yellow-400 font-semibold"></span></span>
                    <a href="../../backend/logout_handler.php" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                        <i class="fas fa-sign-out-alt mr-1"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="pt-24 pb-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="stat-card p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-slate-400 text-sm font-semibold">Total Users</h3>
                        <i class="fas fa-users text-2xl text-yellow-400"></i>
                    </div>
                    <p class="text-3xl font-black text-white" id="total-users">0</p>
                </div>
                <div class="stat-card p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-slate-400 text-sm font-semibold">Total Jobs</h3>
                        <i class="fas fa-briefcase text-2xl text-blue-400"></i>
                    </div>
                    <p class="text-3xl font-black text-white" id="total-jobs">0</p>
                </div>
                <div class="stat-card p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-slate-400 text-sm font-semibold">Applications</h3>
                        <i class="fas fa-file-alt text-2xl text-green-400"></i>
                    </div>
                    <p class="text-3xl font-black text-white" id="total-applications">0</p>
                </div>
                <div class="stat-card p-6 rounded-xl">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-slate-400 text-sm font-semibold">Messages</h3>
                        <i class="fas fa-envelope text-2xl text-purple-400"></i>
                    </div>
                    <p class="text-3xl font-black text-white" id="total-messages">0</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex flex-wrap gap-2 mb-6">
                <button class="tab-button active px-6 py-3 rounded-lg font-semibold" data-tab="users">
                    <i class="fas fa-users mr-2"></i>Users
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold bg-slate-700 text-slate-300" data-tab="jobs">
                    <i class="fas fa-briefcase mr-2"></i>Jobs
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-semibold bg-slate-700 text-slate-300" data-tab="applications">
                    <i class="fas fa-file-alt mr-2"></i>Applications
                </button>
            </div>

            <!-- Content Sections -->
            <div id="users-section" class="tab-content">
                <div class="data-table p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white">Manage Users</h2>
                        <input type="text" id="search-users" placeholder="Search users..." class="bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-yellow-400 focus:outline-none">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800 text-slate-300">
                                <tr>
                                    <th class="px-4 py-3">ID</th>
                                    <th class="px-4 py-3">Name</th>
                                    <th class="px-4 py-3">Email</th>
                                    <th class="px-4 py-3">Roles</th>
                                    <th class="px-4 py-3">Joined</th>
                                    <th class="px-4 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body" class="text-slate-300">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="jobs-section" class="tab-content hidden">
                <div class="data-table p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white">Manage Jobs</h2>
                        <input type="text" id="search-jobs" placeholder="Search jobs..." class="bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-yellow-400 focus:outline-none">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800 text-slate-300">
                                <tr>
                                    <th class="px-4 py-3">ID</th>
                                    <th class="px-4 py-3">Title</th>
                                    <th class="px-4 py-3">Company</th>
                                    <th class="px-4 py-3">Location</th>
                                    <th class="px-4 py-3">Posted</th>
                                    <th class="px-4 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-table-body" class="text-slate-300">
                                <!-- Jobs will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="applications-section" class="tab-content hidden">
                <div class="data-table p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white">Manage Applications</h2>
                        <input type="text" id="search-applications" placeholder="Search applications..." class="bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-yellow-400 focus:outline-none">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800 text-slate-300">
                                <tr>
                                    <th class="px-4 py-3">ID</th>
                                    <th class="px-4 py-3">Applicant</th>
                                    <th class="px-4 py-3">Job</th>
                                    <th class="px-4 py-3">Status</th>
                                    <th class="px-4 py-3">Applied On</th>
                                    <th class="px-4 py-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="applications-table-body" class="text-slate-300">
                                <!-- Applications will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-white">Edit User</h3>
                <button class="close-modal text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="edit-user-form" class="space-y-4">
                <input type="hidden" id="edit-user-id">
                <div>
                    <label class="block text-sm font-semibold text-slate-300 mb-2">Full Name</label>
                    <input type="text" id="edit-user-name" class="w-full bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-yellow-400 focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-300 mb-2">Email</label>
                    <input type="email" id="edit-user-email" class="w-full bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-yellow-400 focus:outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-300 mb-2">Roles</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="roles" value="jobseeker" class="mr-2">
                            <span class="text-slate-300">Job Seeker</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="roles" value="employer" class="mr-2">
                            <span class="text-slate-300">Employer</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="roles" value="admin" class="mr-2">
                            <span class="text-slate-300">Admin</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="close-modal bg-slate-600 hover:bg-slate-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">Cancel</button>
                    <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-slate-900 px-6 py-2 rounded-lg font-semibold transition-colors">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Check admin auth
        async function checkAdminAuth() {
            try {
                const response = await fetch('../../backend/check_auth.php', {
                    credentials: 'same-origin',
                    cache: 'no-store'
                });
                const data = await response.json();
                
                if (!data.loggedin || !data.roles || !data.roles.includes('admin')) {
                    alert('Access denied. Admin privileges required.');
                    window.location.href = '../../index.html';
                    return false;
                }
                
                document.getElementById('admin-name').textContent = data.full_name;
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '../../index.html';
                return false;
            }
        }

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                
                // Update buttons
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.add('bg-slate-700', 'text-slate-300');
                });
                button.classList.add('active');
                button.classList.remove('bg-slate-700', 'text-slate-300');
                
                // Update content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tab}-section`).classList.remove('hidden');
            });
        });

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('../../backend/admin/admin_get_stats.php', {
                    credentials: 'same-origin'
                });
                const stats = await response.json();
                
                if (stats.success) {
                    document.getElementById('total-users').textContent = stats.users || 0;
                    document.getElementById('total-jobs').textContent = stats.jobs || 0;
                    document.getElementById('total-applications').textContent = stats.applications || 0;
                    document.getElementById('total-messages').textContent = stats.messages || 0;
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('../../backend/admin/admin_get_users.php', {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('users-table-body');
                    tbody.innerHTML = data.users.map(user => `
                        <tr class="table-row">
                            <td class="px-4 py-3">${user.id}</td>
                            <td class="px-4 py-3 font-semibold">${user.full_name}</td>
                            <td class="px-4 py-3">${user.email}</td>
                            <td class="px-4 py-3">
                                ${user.roles.split(',').map(role => `<span class="inline-block bg-slate-700 px-2 py-1 rounded text-xs mr-1">${role}</span>`).join('')}
                            </td>
                            <td class="px-4 py-3">${new Date(user.created_at).toLocaleDateString()}</td>
                            <td class="px-4 py-3">
                                <button onclick="editUser(${user.id})" class="btn-edit text-white px-3 py-1 rounded text-sm mr-2">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button onclick="deleteUser(${user.id})" class="btn-delete text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        // Load jobs
        async function loadJobs() {
            try {
                const response = await fetch('../../backend/admin/admin_get_jobs.php', {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('jobs-table-body');
                    tbody.innerHTML = data.jobs.map(job => `
                        <tr class="table-row">
                            <td class="px-4 py-3">${job.id}</td>
                            <td class="px-4 py-3 font-semibold">${job.job_title}</td>
                            <td class="px-4 py-3">${job.company_name}</td>
                            <td class="px-4 py-3">${job.location}</td>
                            <td class="px-4 py-3">${new Date(job.posted_at).toLocaleDateString()}</td>
                            <td class="px-4 py-3">
                                <button onclick="deleteJob(${job.id})" class="btn-delete text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load jobs:', error);
            }
        }

        // Load applications
        async function loadApplications() {
            try {
                const response = await fetch('../../backend/admin/admin_get_applications.php', {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('applications-table-body');
                    tbody.innerHTML = data.applications.map(app => `
                        <tr class="table-row">
                            <td class="px-4 py-3">${app.id}</td>
                            <td class="px-4 py-3 font-semibold">${app.full_name}</td>
                            <td class="px-4 py-3">${app.job_title}</td>
                            <td class="px-4 py-3"><span class="inline-block bg-green-700 px-2 py-1 rounded text-xs">${app.status}</span></td>
                            <td class="px-4 py-3">${new Date(app.applied_at).toLocaleDateString()}</td>
                            <td class="px-4 py-3">
                                <button onclick="deleteApplication(${app.id})" class="btn-delete text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load applications:', error);
            }
        }

        // Delete functions
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This will also delete all their jobs and applications.')) return;
            
            try {
                const response = await fetch('../../backend/admin/admin_delete_user.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('User deleted successfully');
                    loadUsers();
                    loadStats();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Delete failed:', error);
                alert('Failed to delete user');
            }
        }

        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job? This will also delete all applications for this job.')) return;
            
            try {
                const response = await fetch('../../backend/admin/admin_delete_job.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ job_id: jobId })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Job deleted successfully');
                    loadJobs();
                    loadStats();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Delete failed:', error);
                alert('Failed to delete job');
            }
        }

        async function deleteApplication(appId) {
            if (!confirm('Are you sure you want to delete this application?')) return;
            
            try {
                const response = await fetch('../../backend/admin/admin_delete_application.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ application_id: appId })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Application deleted successfully');
                    loadApplications();
                    loadStats();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Delete failed:', error);
                alert('Failed to delete application');
            }
        }

        // Edit user function
        async function editUser(userId) {
            try {
                const response = await fetch(`../../backend/admin/admin_get_user.php?id=${userId}`, {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('edit-user-id').value = data.user.id;
                    document.getElementById('edit-user-name').value = data.user.full_name;
                    document.getElementById('edit-user-email').value = data.user.email;
                    
                    // Set role checkboxes
                    const roles = data.user.roles.split(',');
                    document.querySelectorAll('input[name="roles"]').forEach(checkbox => {
                        checkbox.checked = roles.includes(checkbox.value);
                    });
                    
                    document.getElementById('edit-user-modal').classList.add('active');
                }
            } catch (error) {
                console.error('Failed to load user:', error);
            }
        }

        // Edit form submit
        document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userId = document.getElementById('edit-user-id').value;
            const name = document.getElementById('edit-user-name').value;
            const email = document.getElementById('edit-user-email').value;
            const roles = Array.from(document.querySelectorAll('input[name="roles"]:checked')).map(cb => cb.value);
            
            try {
                const response = await fetch('../../backend/admin/admin_update_user.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ user_id: userId, full_name: name, email, roles })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('User updated successfully');
                    document.getElementById('edit-user-modal').classList.remove('active');
                    loadUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Update failed:', error);
                alert('Failed to update user');
            }
        });

        // Modal close handlers
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            });
        });

        // Search functionality
        document.getElementById('search-users').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('#users-table-body tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        });

        document.getElementById('search-jobs').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('#jobs-table-body tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        });

        document.getElementById('search-applications').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('#applications-table-body tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            const isAdmin = await checkAdminAuth();
            if (isAdmin) {
                loadStats();
                loadUsers();
                loadJobs();
                loadApplications();
            }
        });
    </script>
</body>
</html>
